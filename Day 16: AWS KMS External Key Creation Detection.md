# Alert Title: AWS KMS External Key Creation Detection
<br>

## **Description**
This query identifies AWS KMS keys created with an **EXTERNAL origin**, which indicates the key material is imported rather than generated by AWS. <br>
It monitors AWS CloudTrail logs for `CreateKey` events from `kms.amazonaws.com` and extracts key metadata such as Key ID, ARN, and origin. <br>
<br>
This helps analysts quickly: <br>
■  Detect creation of externally managed cryptographic keys <br>
■  Validate compliance with key management and encryption policies <br>
■  Investigate potential misuse or unauthorized key creation <br>

The diagram below demonstrates the attack flow:
<img width="1045" height="707" alt="image" src="https://github.com/user-attachments/assets/19b6bfe2-7130-4357-99e9-a99d9f515dcf" />



<br>
<br>
<br>

## **Threats**
■ Unauthorized or unexpected creation of externally managed KMS keys <br>
■ Potential evasion of centralized key management controls <br>
■ Risk of importing weak, compromised, or non-compliant key material <br>

<br>
<br>

## **MITRE ATT&CK Techniques**

### **Tactics**
■ Command and Control <br>
■ Credential Access <br>

<br>

### **Techniques**
■ **T1552.004 – Unsecured Credentials: Private Keys**: https://attack.mitre.org/techniques/T1552/004/ <br>
■ **T1573 – Encrypted Channel**: https://attack.mitre.org/techniques/T1573/ <br>


## **Severity**
**Medium**: External KMS key creation may be legitimate but requires validation to ensure compliance and authorization.
<br>
<br>

## **Detection Type** 
■ Cloud Security Monitoring <br>
■ Key Management Oversight <br>
■ Compliance & Governance Detection <br>

<br>
<br>

## **Data Sources**
### **Microsoft Sentinel**
■ **AWS**: `AWSCloudTrail`

<br>

## **False Positives**
■ Approved use cases involving HSMs or third-party key management systems <br>
■ Legitimate key import operations by security or compliance teams <br>


<br>

--- 

## **KQL Query 1**

```kusto
AWSCloudTrail
| where EventSource == "kms.amazonaws.com"
| where EventName == "CreateKey"
| extend KeyId = tostring(parse_json(ResponseElements).keyMetadata.keyId)
| extend KeyArn = tostring(parse_json(ResponseElements).keyMetadata.arn)
| extend Origin = tostring(parse_json(ResponseElements).keyMetadata.origin)
| where Origin == "EXTERNAL"
| project TimeGenerated, UserIdentityArn, SourceIpAddress, KeyId, KeyArn, Origin, UserAgent
| order by TimeGenerated desc


```

--- 
<br>
<br>

## **References**
■ Kao, J. (2025) The Complexity of Detecting Amazon S3 and KMS Ransomware, Fog Security, 7th April [Blog]. Available at: https://www.fogsecurity.io/blog/how-to-detect-amazon-s3-ransomware <br>
■ Verma, Y. (2025) Breaking Down S3 Ransomware: Variants, Attack Paths and Trend Vision One™ Defenses, Trend Micro, 18th November [Blog]. Available at: https://www.trendmicro.com/en_us/research/25/k/s3-ransomware.html <br>

<br>

## **Author**
**Faiza Aslam**
